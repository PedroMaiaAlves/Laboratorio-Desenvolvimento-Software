<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Cadastro - Moeda Estudantil</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Quantico:ital,wght@0,400;0,700;1,400;1,700&display=swap" rel="stylesheet">
    <script src="scripts/input-mask.js"></script>
    <style>
        /* Estilos específicos para página de cadastro */
        .auth-card {
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
        }

        .tipo-usuario-group {
            margin-bottom: 2rem;
        }

        .tipo-usuario-group > label {
            display: block;
            margin-bottom: 0.75rem;
            color: var(--text-color);
            font-weight: 600;
        }

        .tipo-usuario-options {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .tipo-option {
            flex: 1;
            min-width: 150px;
        }

        .tipo-option input[type="radio"] {
            display: none;
        }

        .tipo-option label {
            display: block;
            padding: 1rem;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 600;
            color: var(--text-light);
            background: rgba(255, 255, 255, 0.9);
        }

        .tipo-option input[type="radio"]:checked + label {
            border-color: var(--primary-color);
            background: var(--primary-color);
            color: white;
            box-shadow: 0 4px 15px rgba(255, 184, 0, 0.3);
        }

        .tipo-option label:hover {
            border-color: var(--primary-color);
            background: white;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .error-message, .success-message {
            padding: 0.75rem;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            text-align: center;
            display: none;
            font-weight: 600;
        }

        .error-message {
            background: rgba(220, 38, 38, 0.1);
            color: var(--danger-color);
            border: 1px solid rgba(220, 38, 38, 0.3);
        }

        .success-message {
            background: rgba(22, 163, 74, 0.1);
            color: var(--success-color);
            border: 1px solid rgba(22, 163, 74, 0.3);
        }
    </style>
</head>
<body class="video-bg">
    <!-- Vídeo de Fundo -->
    <div class="video-background">
        <video autoplay muted loop playsinline>
            <source src="imagens/Time Lapse - PUC Minas Coração Eucarístico.mp4" type="video/mp4">
            <!-- Fallback para navegadores que não suportam vídeo -->
            Seu navegador não suporta vídeos HTML5.
        </video>
    </div>
    
    <!-- Overlay para melhorar legibilidade -->
    <div class="video-overlay"></div>

    <!-- Container de Autenticação -->
    <div class="auth-container">
        <div class="auth-card">
            <div class="cadastro-header" style="text-align: center; margin-bottom: 2rem;">
                <img src="imagens/Moedalogo.png" alt="Moeda Estudantil Logo" style="max-width: 120px; margin-bottom: 1rem;">
                <h1>Cadastro</h1>
            </div>

            <div id="error-message" class="error-message"></div>
            <div id="success-message" class="success-message"></div>

        <form id="cadastro-form">
            <!-- Seleção de Tipo de Usuário -->
            <div class="tipo-usuario-group">
                <label>Tipo de Conta *</label>
                <div class="tipo-usuario-options">
                    <div class="tipo-option">
                        <input type="radio" id="tipo-aluno" name="tipoUsuario" value="ALUNO" required>
                        <label for="tipo-aluno">Aluno</label>
                    </div>
                    <div class="tipo-option">
                        <input type="radio" id="tipo-professor" name="tipoUsuario" value="PROFESSOR" required>
                        <label for="tipo-professor">Professor</label>
                    </div>
                    <div class="tipo-option">
                        <input type="radio" id="tipo-empresa" name="tipoUsuario" value="EMPRESA" required>
                        <label for="tipo-empresa">Empresa</label>
                    </div>
                </div>
            </div>

            <!-- Campos Comuns -->
            <div class="form-section" id="campos-comuns">
                <div class="form-group">
                    <label for="email">Email *</label>
                    <input type="email" id="email" name="email" required placeholder="exemplo@email.com">
                </div>
                <div class="form-group">
                    <label for="senha">Senha *</label>
                    <input type="password" id="senha" name="senha" required minlength="6" placeholder="Mínimo 6 caracteres">
                </div>
            </div>

            <!-- Campos Específicos de Aluno -->
            <div class="form-section hidden" id="campos-aluno">
                <div class="form-group">
                    <label for="aluno-nome">Nome Completo *</label>
                    <input type="text" id="aluno-nome" name="nome" placeholder="Nome completo">
                </div>
                <div class="form-group formatted-input cpf-input" data-format="000.000.000-00">
                    <label for="aluno-cpf">CPF *</label>
                    <input type="text" id="aluno-cpf" name="cpf" 
                           pattern="\d{3}\.\d{3}\.\d{3}-\d{2}"
                           maxlength="14"
                           placeholder="000.000.000-00">
                </div>
                <div class="form-group formatted-input rg-input" data-format="00.000.000-0">
                    <label for="aluno-rg">RG *</label>
                    <input type="text" id="aluno-rg" name="rg" 
                           pattern="[0-9]{2}\.[0-9]{3}\.[0-9]{3}-[0-9]"
                           maxlength="12"
                           placeholder="00.000.000-0">
                </div>
                <div class="form-group">
                    <label for="aluno-endereco">Endereço *</label>
                    <input type="text" id="aluno-endereco" name="endereco" placeholder="Endereço completo">
                </div>
            </div>

            <!-- Campos Específicos de Professor -->
            <div class="form-section hidden" id="campos-professor">
                <div class="form-group">
                    <label for="professor-nome">Nome Completo *</label>
                    <input type="text" id="professor-nome" name="nome" placeholder="Nome completo">
                </div>
                <div class="form-group formatted-input cpf-input" data-format="000.000.000-00">
                    <label for="professor-cpf">CPF *</label>
                    <input type="text" id="professor-cpf" name="cpf" 
                           pattern="\d{3}\.\d{3}\.\d{3}-\d{2}"
                           maxlength="14"
                           placeholder="000.000.000-00">
                </div>
                <div class="form-group">
                    <label for="professor-departamento">Departamento *</label>
                    <input type="text" id="professor-departamento" name="departamento" placeholder="Departamento">
                </div>
                <div class="form-group">
                    <label for="professor-instituicao">Instituição *</label>
                    <input type="text" id="professor-instituicao" name="instituicao" placeholder="Instituição de ensino">
                </div>
            </div>

            <!-- Campos Específicos de Empresa -->
            <div class="form-section hidden" id="campos-empresa">
                <div class="form-group">
                    <label for="empresa-razaoSocial">Razão Social *</label>
                    <input type="text" id="empresa-razaoSocial" name="razaoSocial" placeholder="Razão social da empresa">
                </div>
                <div class="form-group formatted-input cnpj-input" data-format="00.000.000/0000-00">
                    <label for="empresa-cnpj">CNPJ *</label>
                    <input type="text" id="empresa-cnpj" name="cnpj"
                           pattern="\d{2}\.\d{3}\.\d{3}\/\d{4}-\d{2}"
                           maxlength="18"
                           placeholder="00.000.000/0000-00">
                </div>
                <div class="form-group formatted-input phone-input" data-format="(00) 00000-0000">
                    <label for="empresa-telefone">Telefone *</label>
                    <input type="text" id="empresa-telefone" name="telefone"
                           pattern="\([0-9]{2}\) [0-9]{5}-[0-9]{4}"
                           maxlength="15"
                           placeholder="(00) 00000-0000">
                </div>
            </div>

            <button type="submit" class="btn btn-primary" id="cadastrar-btn">Cadastrar</button>
        </form>

        <div class="cadastro-links" style="text-align: center; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border-color);">
            <p style="color: var(--text-light); margin-bottom: 0.5rem;">Já tem uma conta?</p>
            <a href="login.html" style="color: var(--primary-color); text-decoration: none; font-weight: 600;">Faça login aqui</a>
        </div>
        </div>
    </div>

    <script src="scripts/config.js"></script>
    <script src="scripts/video-background.js"></script>
    <script src="scripts/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const cadastroForm = document.getElementById('cadastro-form');
            const cadastrarBtn = document.getElementById('cadastrar-btn');
            const errorMessage = document.getElementById('error-message');
            const successMessage = document.getElementById('success-message');
            const tipoUsuarioRadios = document.querySelectorAll('input[name="tipoUsuario"]');

            // Mostrar/ocultar campos baseado no tipo selecionado
            tipoUsuarioRadios.forEach(radio => {
                radio.addEventListener('change', (e) => {
                    const tipo = e.target.value;
                    
                    // Ocultar todos os campos específicos
                    document.getElementById('campos-aluno').classList.add('hidden');
                    document.getElementById('campos-professor').classList.add('hidden');
                    document.getElementById('campos-empresa').classList.add('hidden');

                    // Mostrar campos do tipo selecionado
                    if (tipo === 'ALUNO') {
                        document.getElementById('campos-aluno').classList.remove('hidden');
                        // Tornar campos obrigatórios
                        document.querySelectorAll('#campos-aluno input').forEach(input => {
                            input.required = true;
                        });
                        // Remover required dos outros
                        document.querySelectorAll('#campos-professor input, #campos-empresa input').forEach(input => {
                            input.required = false;
                        });
                    } else if (tipo === 'PROFESSOR') {
                        document.getElementById('campos-professor').classList.remove('hidden');
                        document.querySelectorAll('#campos-professor input').forEach(input => {
                            input.required = true;
                        });
                        document.querySelectorAll('#campos-aluno input, #campos-empresa input').forEach(input => {
                            input.required = false;
                        });
                    } else if (tipo === 'EMPRESA') {
                        document.getElementById('campos-empresa').classList.remove('hidden');
                        document.querySelectorAll('#campos-empresa input').forEach(input => {
                            input.required = true;
                        });
                        document.querySelectorAll('#campos-aluno input, #campos-professor input').forEach(input => {
                            input.required = false;
                        });
                    }
                });
            });

            const showError = (message) => {
                errorMessage.textContent = message;
                errorMessage.style.display = 'block';
                successMessage.style.display = 'none';
                setTimeout(() => {
                    errorMessage.style.display = 'none';
                }, 5000);
            };

            const showSuccess = (message) => {
                successMessage.textContent = message;
                successMessage.style.display = 'block';
                errorMessage.style.display = 'none';
                setTimeout(() => {
                    successMessage.style.display = 'none';
                }, 5000);
            };

            const apiCall = async (url, method, body = null) => {
                try {
                    const options = {
                        method,
                        headers: { 'Content-Type': 'application/json' },
                    };
                    if (body) options.body = JSON.stringify(body);

                    const response = await fetch(url, options);
                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({ message: `Erro na operação de ${method}` }));
                        throw new Error(errorData.message || `HTTP error! status: ${response.status}`);
                    }
                    return response.status !== 204 ? await response.json() : true;
                } catch (error) {
                    throw error;
                }
            };

            cadastroForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                cadastrarBtn.disabled = true;
                errorMessage.style.display = 'none';
                successMessage.style.display = 'none';

                const tipoUsuario = document.querySelector('input[name="tipoUsuario"]:checked')?.value;
                if (!tipoUsuario) {
                    showError('Por favor, selecione um tipo de conta.');
                    cadastrarBtn.disabled = false;
                    return;
                }

                let url, payload;

                if (tipoUsuario === 'ALUNO') {
                    // Buscar valores diretamente dos campos específicos de aluno
                    const nome = document.getElementById('aluno-nome')?.value;
                    const cpf = document.getElementById('aluno-cpf')?.value;
                    const rg = document.getElementById('aluno-rg')?.value;
                    const endereco = document.getElementById('aluno-endereco')?.value;
                    const email = document.getElementById('email')?.value;
                    const senha = document.getElementById('senha')?.value;

                    if (!nome || !cpf || !rg || !endereco || !email || !senha) {
                        showError('Por favor, preencha todos os campos obrigatórios.');
                        cadastrarBtn.disabled = false;
                        return;
                    }

                    url = `${API_BASE_URL}/alunos/cadastrar`;
                    payload = {
                        nome: nome.trim(),
                        email: email.trim(),
                        cpf: cpf.trim(),
                        rg: rg.trim(),
                        endereco: endereco.trim(),
                        senha: senha
                    };
                } else if (tipoUsuario === 'PROFESSOR') {
                    // Buscar valores diretamente dos campos específicos de professor
                    const nome = document.getElementById('professor-nome')?.value;
                    const cpf = document.getElementById('professor-cpf')?.value;
                    const departamento = document.getElementById('professor-departamento')?.value;
                    const instituicao = document.getElementById('professor-instituicao')?.value;
                    const email = document.getElementById('email')?.value;
                    const senha = document.getElementById('senha')?.value;

                    if (!nome || !cpf || !departamento || !instituicao || !email || !senha) {
                        showError('Por favor, preencha todos os campos obrigatórios.');
                        cadastrarBtn.disabled = false;
                        return;
                    }

                    url = `${API_BASE_URL}/professores`;
                    payload = {
                        nome: nome.trim(),
                        email: email.trim(),
                        cpf: cpf.trim(),
                        departamento: departamento.trim(),
                        instituicao: instituicao.trim(),
                        senha: senha
                    };
                } else if (tipoUsuario === 'EMPRESA') {
                    // Buscar valores diretamente dos campos específicos de empresa
                    const razaoSocial = document.getElementById('empresa-razaoSocial')?.value;
                    const cnpj = document.getElementById('empresa-cnpj')?.value;
                    const telefone = document.getElementById('empresa-telefone')?.value;
                    const email = document.getElementById('email')?.value;
                    const senha = document.getElementById('senha')?.value;

                    if (!razaoSocial || !cnpj || !telefone || !email || !senha) {
                        showError('Por favor, preencha todos os campos obrigatórios.');
                        cadastrarBtn.disabled = false;
                        return;
                    }

                    url = `${API_BASE_URL}/empresas/create`;
                    payload = {
                        razaoSocial: razaoSocial.trim(),
                        cnpj: cnpj.trim(),
                        email: email.trim(),
                        telefone: telefone.trim(),
                        senha: senha
                    };
                }

                try {
                    const result = await apiCall(url, 'POST', payload);
                    if (result) {
                        showSuccess('Cadastro realizado com sucesso! Redirecionando para login...');
                        setTimeout(() => {
                            window.location.href = 'login.html';
                        }, 2000);
                    }
                } catch (error) {
                    showError(error.message || 'Erro ao realizar cadastro. Tente novamente.');
                    cadastrarBtn.disabled = false;
                }
            });
        });
    </script>
</body>
</html>

