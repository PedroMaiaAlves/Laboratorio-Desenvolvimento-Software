<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gerenciamento Acadêmico</title>
    <link rel="stylesheet" href="styles.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script src="scripts/email-service.js"></script>
    <script src="scripts/auth.js"></script>
</head>
<body>
    
    <header>

        <div class="imagem"><img src="imagens/Moedalogo.png"></div>
        <div class="container">
            <div class="header-content">
                <h1 id="main-title">Alunos</h1>
                <div class="tabs">
                    <button class="tab-btn active" data-tab="alunos">Alunos</button>
                    <button class="tab-btn" data-tab="empresas">Empresas</button>
                    <button class="tab-btn" data-tab="professores">Professores</button>
                    <button class="tab-btn" data-tab="acoes">Ações</button>
                    <a href="vantagens.html" class="tab-btn">Vantagens</a>
                </div>
            </div>
            <button id="add-btn" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" width="20" height="20">
                    <path d="M11 11V5H13V11H19V13H13V19H11V13H5V11H11Z"></path>
                </svg>
                <span id="add-btn-text">Novo Aluno</span>
            </button>
        </div>
    </header>

    <!-- Seção de Alunos -->
    <main class="container" id="main-content-alunos">
        <div id="alunos-list" class="data-grid"></div>
    </main>

    <!-- Seção de Empresas -->
    <main class="container hidden" id="main-content-empresas">
        <div id="empresas-list" class="data-grid"></div>
    </main>

    <!-- Seção de Professores -->
    <main class="container hidden" id="main-content-professores">
        <div id="professores-list" class="data-grid"></div>
    </main>

    <!-- Seção de Ações -->
    <main class="container hidden" id="main-content-acoes">
        <div class="actions-container">
            <!-- Ações do Aluno -->
            <div class="action-card">
                <h2>Ações do Aluno</h2>
                <div class="form-group">
                    <label for="select-aluno-acao">Selecione um Aluno</label>
                    <select id="select-aluno-acao"></select>
                </div>
                <div id="aluno-actions-view" class="hidden">
                    <div class="saldo-container">
                        <h3>Saldo de Moedas</h3>
                        <p id="aluno-saldo">R$ 0,00</p>
                    </div>
                    <h3>Extrato de Transações</h3>
                    <div id="aluno-extrato-list" class="table-container">
                        <p>Nenhuma transação encontrada.</p>
                    </div>
                </div>
            </div>

            <!-- Ações do Professor -->
            <div class="action-card">
                <h2>Ações do Professor</h2>
                <div class="form-group" id="select-professor-group">
                    <label for="select-professor-acao">Selecione um Professor</label>
                    <select id="select-professor-acao"></select>
                </div>
                <div id="professor-actions-view" class="hidden">
                    <!-- Distribuir Moedas -->
                    <div id="distribute-coins-container">
                        <h3>Distribuir Moedas</h3>
                        <form id="distribute-coins-form">
                            <input type="hidden" id="distribute-professor-id">
                            <div class="form-group">
                                <label for="distribute-aluno-id">Selecione o Aluno</label>
                                <select id="distribute-aluno-id" name="alunoId" required>
                                    <option value="">Selecione um aluno</option>
                                </select>
                            </div>
                            <div class="form-group">
                                <label for="distribute-quantidade">Quantidade de Moedas</label>
                                <input type="number" id="distribute-quantidade" name="quantidadeMoedas" step="0.01" required>
                            </div>
                            <div class="form-group">
                                <label for="distribute-motivo">Motivo</label>
                                <input type="text" id="distribute-motivo" name="motivo" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Enviar Moedas</button>
                        </form>
                    </div>
                    <!-- Extrato do Professor -->
                    <div id="professor-extrato-container">
                        <h3>Extrato de Envios</h3>
                        <div id="professor-extrato-list" class="table-container">
                            <p>Nenhum envio encontrado.</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- MODAIS DE ALUNO -->
    <div id="form-aluno-modal" class="modal" aria-hidden="true">
        <div class="modal-overlay" tabindex="-1" data-close></div>
        <div class="modal-content" role="dialog" aria-modal="true">
            <button class="modal-close-btn" data-close aria-label="Fechar modal">&times;</button>
            <h2 id="form-aluno-title"></h2>
            <form id="aluno-form">
                <input type="hidden" id="aluno-id" name="id">
                <div class="form-group">
                    <label for="aluno-nome-form">Nome Completo</label>
                    <input type="text" id="aluno-nome-form" name="nome" required>
                </div>
                <div class="form-group formatted-input email-input" data-format="exemplo@email.com">
                    <label for="aluno-email-form">Email</label>
                    <input type="email" id="aluno-email-form" name="email" 
                           pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
                           placeholder="exemplo@email.com"
                           required>
                </div>
                <div class="form-group formatted-input cpf-input" data-format="000.000.000-00">
                    <label for="aluno-cpf-form">CPF</label>
                    <input type="text" id="aluno-cpf-form" name="cpf" 
                           pattern="\d{3}\.\d{3}\.\d{3}-\d{2}"
                           maxlength="14"
                           placeholder="000.000.000-00"
                           required>
                </div>
                <div class="form-group formatted-input rg-input" data-format="00.000.000-0">
                    <label for="aluno-rg-form">RG</label>
                    <input type="text" id="aluno-rg-form" name="rg" 
                           pattern="[0-9]{2}\.[0-9]{3}\.[0-9]{3}-[0-9]"
                           maxlength="12"
                           placeholder="00.000.000-0"
                           required>
                </div>
                <div class="form-group">
                    <label for="aluno-endereco-form">Endereço</label>
                    <input type="text" id="aluno-endereco-form" name="endereco" required>
                </div>
                <div class="form-group" id="aluno-senha-group">
                    <label for="aluno-senha-form">Senha</label>
                    <input type="password" id="aluno-senha-form" name="senha" required minlength="6">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" data-close>Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>
    <div id="delete-aluno-confirm-modal" class="modal" aria-hidden="true">
        <div class="modal-overlay" tabindex="-1" data-close></div>
        <div class="modal-content" role="dialog" aria-modal="true">
            <h2>Confirmar Exclusão</h2>
            <p>Deseja excluir o aluno <strong id="delete-aluno-name"></strong>?</p>
            <div class="form-actions"><button type="button" class="btn btn-secondary" data-close>Cancelar</button><button type="button" id="confirm-delete-aluno-btn" class="btn btn-danger">Excluir</button></div>
        </div>
    </div>

    <!-- MODAIS DE EMPRESA -->
    <div id="form-empresa-modal" class="modal" aria-hidden="true">
        <div class="modal-overlay" tabindex="-1" data-close></div>
        <div class="modal-content" role="dialog" aria-modal="true">
            <button class="modal-close-btn" data-close aria-label="Fechar modal">&times;</button>
            <h2 id="form-empresa-title"></h2>
            <form id="empresa-form">
                <input type="hidden" id="empresa-id" name="id">
                <div class="form-group">
                    <label for="empresa-razaoSocial-form">Razão Social</label>
                    <input type="text" id="empresa-razaoSocial-form" name="razaoSocial" required>
                </div>
                <div class="form-group formatted-input cnpj-input" data-format="00.000.000/0000-00">
                    <label for="empresa-cnpj-form">CNPJ</label>
                    <input type="text" id="empresa-cnpj-form" name="cnpj"
                           pattern="\d{2}\.\d{3}\.\d{3}\/\d{4}-\d{2}"
                           maxlength="18"
                           placeholder="00.000.000/0000-00"
                           required>
                </div>
                <div class="form-group formatted-input email-input" data-format="exemplo@empresa.com">
                    <label for="empresa-email-form">Email</label>
                    <input type="email" id="empresa-email-form" name="email"
                           pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
                           placeholder="exemplo@empresa.com"
                           required>
                </div>
                <div class="form-group formatted-input phone-input" data-format="(00) 00000-0000">
                    <label for="empresa-telefone-form">Telefone</label>
                    <input type="text" id="empresa-telefone-form" name="telefone"
                           pattern="\([0-9]{2}\) [0-9]{5}-[0-9]{4}"
                           maxlength="15"
                           placeholder="(00) 00000-0000"
                           required>
                </div>
                <div class="form-group" id="empresa-senha-group">
                    <label for="empresa-senha-form">Senha</label>
                    <input type="password" id="empresa-senha-form" name="senha" required minlength="6">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" data-close>Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>
    <div id="delete-empresa-confirm-modal" class="modal" aria-hidden="true">
        <div class="modal-overlay" tabindex="-1" data-close></div>
        <div class="modal-content" role="dialog" aria-modal="true">
            <h2>Confirmar Exclusão</h2>
            <p>Deseja excluir a empresa <strong id="delete-empresa-name"></strong>?</p>
            <div class="form-actions"><button type="button" class="btn btn-secondary" data-close>Cancelar</button><button type="button" id="confirm-delete-empresa-btn" class="btn btn-danger">Excluir</button></div>
        </div>
    </div>

    <!-- MODAIS DE PROFESSOR -->
    <div id="form-professor-modal" class="modal" aria-hidden="true">
        <div class="modal-overlay" tabindex="-1" data-close></div>
        <div class="modal-content" role="dialog" aria-modal="true">
            <button class="modal-close-btn" data-close aria-label="Fechar modal">&times;</button>
            <h2 id="form-professor-title"></h2>
            <form id="professor-form">
                <input type="hidden" id="professor-id" name="id">
                <div class="form-group">
                    <label for="professor-nome-form">Nome Completo</label>
                    <input type="text" id="professor-nome-form" name="nome" required>
                </div>
                <div class="form-group formatted-input email-input" data-format="exemplo@instituicao.edu">
                    <label for="professor-email-form">Email</label>
                    <input type="email" id="professor-email-form" name="email"
                           pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$"
                           placeholder="exemplo@instituicao.edu"
                           required>
                </div>
                <div class="form-group formatted-input cpf-input" data-format="000.000.000-00">
                    <label for="professor-cpf-form">CPF</label>
                    <input type="text" id="professor-cpf-form" name="cpf"
                           pattern="\d{3}\.\d{3}\.\d{3}-\d{2}"
                           maxlength="14"
                           placeholder="000.000.000-00"
                           required>
                </div>
                <div class="form-group">
                    <label for="professor-departamento-form">Departamento</label>
                    <input type="text" id="professor-departamento-form" name="departamento" required>
                </div>
                <div class="form-group">
                    <label for="professor-instituicao-form">Instituição</label>
                    <input type="text" id="professor-instituicao-form" name="instituicao" required>
                </div>
                <div class="form-group" id="professor-senha-group">
                    <label for="professor-senha-form">Senha</label>
                    <input type="password" id="professor-senha-form" name="senha" required minlength="6">
                </div>
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" data-close>Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>
    <div id="delete-professor-confirm-modal" class="modal" aria-hidden="true">
        <div class="modal-overlay" tabindex="-1" data-close></div>
        <div class="modal-content" role="dialog" aria-modal="true">
            <h2>Confirmar Exclusão</h2>
            <p>Deseja excluir o professor <strong id="delete-professor-name"></strong>?</p>
            <div class="form-actions"><button type="button" class="btn btn-secondary" data-close>Cancelar</button><button type="button" id="confirm-delete-professor-btn" class="btn btn-danger">Excluir</button></div>
        </div>
    </div>

    <!-- MODAL DE DETALHES GENÉRICO -->
    <div id="detail-modal" class="modal" aria-hidden="true">
        <div class="modal-overlay" tabindex="-1" data-close></div>
        <div class="modal-content" role="dialog" aria-modal="true">
            <button class="modal-close-btn" data-close aria-label="Fechar modal">&times;</button>
            <div id="detail-modal-content"></div>
        </div>
    </div>

    <div id="toast-container"></div>

    <script src="scripts/config.js"></script>
    <script>
        // Verificar autenticação e permissões ao carregar a página
        document.addEventListener('DOMContentLoaded', () => {
            // Aguardar carregamento do auth.js
            if (typeof AuthService === 'undefined') {
                console.error('AuthService não encontrado. Certifique-se de que scripts/auth.js está carregado.');
                return;
            }
            const role = AuthService.getRole();
            
            // Se não estiver autenticado, redirecionar para login
            if (!role) {
                window.location.href = 'login.html';
                return;
            }

            // Ajustar navegação baseado na role
            if (role === 'ALUNO') {
                // Aluno só pode acessar vantagens
                window.location.href = 'vantagens.html';
                return;
            } else if (role === 'EMPRESA') {
                // Empresa só pode acessar vantagens (para gerenciar)
                window.location.href = 'vantagens.html';
                return;
            } else if (role === 'PROFESSOR') {
                // Professor vê apenas a tela de Ações
                const alunosTab = document.querySelector('[data-tab="alunos"]');
                const empresasTab = document.querySelector('[data-tab="empresas"]');
                const professoresTab = document.querySelector('[data-tab="professores"]');
                const acoesTab = document.querySelector('[data-tab="acoes"]');
                const addBtn = document.getElementById('add-btn');
                const mainTitle = document.getElementById('main-title');

                // Ocultar abas de gerenciamento
                if (alunosTab) alunosTab.style.display = 'none';
                if (empresasTab) empresasTab.style.display = 'none';
                if (professoresTab) professoresTab.style.display = 'none';
                
                // Mostrar e ativar aba de Ações
                if (acoesTab) {
                    acoesTab.style.display = 'block';
                    acoesTab.classList.add('active');
                    // Remover active de outras abas
                    document.querySelectorAll('.tab-btn').forEach(tab => {
                        if (tab !== acoesTab) tab.classList.remove('active');
                    });
                }

                // Ocultar botão de adicionar
                if (addBtn) addBtn.style.display = 'none';

                // Ajustar título
                if (mainTitle) {
                    mainTitle.innerHTML = '<svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"></circle><polyline points="12 6 12 12 16 14"></polyline></svg>Ações';
                }

                // Ocultar seções de alunos, empresas e professores
                // O app.js já vai inicializar na view de ações automaticamente
            } else {
                // Role desconhecida, redirecionar para login
                window.location.href = 'login.html';
                return;
            }

            // Adicionar botão de logout no header
            const headerContent = document.querySelector('.header-content');
            if (headerContent) {
                const userInfo = AuthService.getUserInfo();
                const logoutBtn = document.createElement('button');
                // Adicionar classe especial para professor
                logoutBtn.className = role === 'PROFESSOR' ? 'btn btn-logout-professor' : 'btn btn-secondary';
                logoutBtn.style.marginLeft = 'auto';
                logoutBtn.innerHTML = `<span>${userInfo?.nome || 'Usuário'} - Sair</span>`;
                logoutBtn.addEventListener('click', () => {
                    AuthService.logout();
                    window.location.href = 'login.html';
                });
                headerContent.appendChild(logoutBtn);
            }
        });
    </script>
    <script src="app.js"></script>
    <script src="scripts/input-mask.js"></script>
</body>
</html>
